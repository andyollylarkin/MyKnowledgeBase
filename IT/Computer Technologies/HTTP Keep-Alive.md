---
aliases: [http keep-alive, keep-alive, keep alive]
tags: [http, web, net, network, golang, go]
---
<h6>21-02-2023</h6>
----------
## Определение
Механизм транспортного протокола [[HTTP]] позволяющий переиспользовать TCP соединение для нескольких последовательных запросов.
> Т.к. разные среды по разному реализуют данный механизм, то пример реализации в данной статье будет исследован на примере реализации HTTP сервера на языке Golang

## Заголовок
Данный механизм контролируется путем установки заголовка **Connection**.
Допустимые значения:
- keep-alive
- close

## Решаемая проблема
При установке значения в *close* каждый последующий запрос на веб сервер будет создавать новое соединение. При таком подходе существует значительная доля накладных расходов на установление TCP соединения.
![[Pasted image 20230221195737.png]]

Решением данной проблемы является переиспользование ранее инициированного соединения для повторных запросов.

## Как устроено переиспользование соединения в HTTP server golang
Golang имеет в своей библиотеке имплементацию веб сервера.
Первично вызывается функция ListenAndServe и объекта сервера. В данной функции создается [[tcp]] сокет. Далее в функции вызывается метод Serve. Опуская детали метод Serve запускает бесконечный цикл который принимает tcp соединения. В данном цикле запускает [[горутина]] serve (не экспортированная функция из пакета сервера). В данной функции запускается еще один бесконечный цикл который обрабатывает запросы. В этом цикле имеется следующий кусок кода
```go
if !w.conn.server.doKeepAlives() {  
   // We're in shutdown mode. We might've replied  
   // to the user without "Connection: close" and   // they      might think they can send another   // request, but such is life with HTTP/1.1.   
   return  
}
```
Если в запросе не установлен заголовок **Connection: keep-alive**, тогда происходит возврат из функции и выше по стеку вызовов tcp сокет будет закрыт. Иначе цикл продолжает обработку текущего клиента с данным сокетом.

---
## Библиография
- [MDN Keep-Alive](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Keep-Alive)