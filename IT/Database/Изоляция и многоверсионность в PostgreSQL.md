---
aliases: []
tags: [db, database, acid, ACID, postgresql, postgres, mv]
---
# Изоляция и многоверсионность в PostgreSQL
<h6>08-03-2022</h6>
----------
## Определение
Технологии [[СУБД]] для обеспечения свойств ACID

## Описание
![[Pasted image 20220308163020.png]]
[[Общая архитектура PostgreSQL#Подключение множества клиентов]]
При одновременном  подключении множества клиентов возникает задача: что делать если две [[Транзакция в БД|транзакции]] одновременно обращаются к одной и той же строке или таблице? Если обе [[Транзакция в БД|транзакции]] читают эти строки, то сложностей нет. 
##### Если обе пишут, тоже сложностей нет(в этом случае они выстраиваются в очередь и пишут друг за другом)
>Однако на уровне приложения с этим могут быть сложности, для решения которых предназначены паттерны [[Optimistic Lock]] и [[Pessimistic Lock]]

Проблемы возникают когда одна [[Транзакция в БД|транзакция]] читает, другая пишет.
[[ACID#Проблемы которые решает изоляция]]
PostgreSQL решает проблемы [[Транзакция в БД#Уровни изоляции транзакций|изоляции]] путем многоверсионности - хранит несколько копий одной и той же строки. Каждая [[Транзакция в БД|транзакция]] при этом видит свою версию.
>Для отличения версий друг от друга, они помечаются двумя отметками  определяющими время действия данной версии. В качестве времени используются всегда возрастающие номера транзакций.

Когда [[Реляционная алгебра и модель данных#Кортеж строка|строка]] создается, она помечается номером [[Транзакция в БД|транзакции]] выполнившей команду **INSERT**, когда удаляется, выполнившей комаманду **DELETE** (но физически не удаляется)
>**UPDATE** состоит из двух операций **DELETE** и **INSERT**

[[Транзакция в БД|Транзакция]] работающая с таблицей, должна видеть только одну версию каждой строки (или не видеть ни одной). Для этого [[Транзакция в БД|транзакция]] работает со снимком данных, созданным в определенный момент времени.
> Снимок это не физическая копия данных, а несколько чисел 
> - номер текущей [[Транзакция в БД|транзакции]] на момент создания снимка
> - список активных транзакций на этот момент

 ## Блокировки
 
![[Pasted image 20220308170503.png]]

Основные блокировки устанавливаются на уровне строк.
- Чтение никогда не блокирует ни читающие, ни пишущие [[Транзакция в БД|транзакции]]
- Изменение строки не блокирует ее чтение

Блокировки также устанавливаются на более высоком уровне, в частности на таблицах. Они нужны для того, чтобы никто не смог удалить таблицу, пока другие [[Транзакция в БД|транзакции]] читают из нее данные, или чтобы запретить доступ к перестраиваемой таблице.

>Все необходимые блокировки устанавливаются автоматически и автоматически же снимаются при завершении [[Транзакция в БД|транзакции]].

## Очистка
В PostgreSQL все версии строк — и актуальные, и старые — хранятся вместе в одном и том же файле данных. Понятно, что со временем старые версии строк накапливаются и это приводит к разрастанию таблиц (и индексов) и снижению производительности. Между тем нет необходимости хранить неактуальные версии строк, которые уже не видны ни в одном снимке данных. Такие версии удаляются специальным процессом очистки (vacuum). Очистка физически удаляет ненужные версии из файлов, оставляя «дыры», которые затем используется для размещения новых версий строк. Очистка не блокирует остальные процессы и работает параллельно с ними. Существует возможность полностью перестроить таблицу и ее индексы, выполнив полную очистку (vacuum full). При этом файлы получаются компактными, но этот процесс полностью блокирует работу с таблицей на время своей работы.

## Автоочистка
Очистка обычно работает автоматически и настраивается администратором так, чтобы очищать данные вовремя, не допуская большого увеличения размера файлов. Для этого автоочистка реагирует на активность изменения данных в таблицах, а не просто запускается по расписанию. Автоочистке соответствует фоновый процесс autovacuum launcher, планирующий работу и запускающий при необходимости рабочие процессы autovacuum worker
![[Pasted image 20220308171859.png]]

---
## Библиография
- [Учебный курс от PostgresPro](https://edu.postgrespro.ru/dba1/dba1_05_arch_mvcc.pdf)
